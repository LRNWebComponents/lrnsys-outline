<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../swipe-action/swipe-action.html">

<!--
`lrnsys-outline-item`
A LRN element

@demo demo/index.html

@microcopy - the mental model for this element
 -
 -
 -

-->

<dom-module id="lrnsys-outline-item">
  <template>
    <style>
      :host {
        display: block;
        --indent-multiplier: 20px;
      }
      :host #swipe {
        height: 40px;
      }
      :host [data-indent="0"] {
        padding-left: 0;
      }
      :host [data-indent="1"] {
        padding-left: calc(var(--indent-multiplier) * 1);
      }
      :host [data-indent="2"] {
        padding-left: calc(var(--indent-multiplier) * 2);
      }
      :host [data-indent="3"] {
        padding-left: calc(var(--indent-multiplier) * 3);
      }
      :host [data-indent="4"] {
        padding-left: calc(var(--indent-multiplier) * 4);
      }
      :host [data-indent="5"] {
        padding-left: calc(var(--indent-multiplier) * 5);
      }
      :host [data-indent="6"] {
        padding-left: calc(var(--indent-multiplier) * 6);
      }
      :host #swipe paper-icon-button {
        position: static;
        font-size: 20px;
        height: 40px;
        width: 40px;
        padding: 10px;
        color: white;
      }
      :host #left {
        display: flex;
        justify-content: flex-end;
      }
      :host #right {
        display: flex;
        justify-content: flex-start;
      }
      :host #swipe paper-icon-button {
        background-color: #222222;
      }
      :host #swipe paper-icon-button#add {
        background-color: #008800;
      }
      :host #swipe paper-icon-button#delete {
        background-color: #cc0000;
      }
      :host #wrapper {
        /*display: inline-flex;*/
        height: 40px;
        background-color: white;
      }
    </style>
    <swipe-action id="swipe">
      <div id="wrapper" data-indent$="[[indent]]">
        <paper-input
          id="input"
          label="Enter a page title"
          value$="[[title]]"
          no-label-float>
        </paper-input>
      </div>
      <!-- Swipe left action -->
      <div id="left" swipe-left-action swipe-size="80" swipe-rubber-band="20">
        <paper-icon-button id="add" title="Add Item" icon="icons:add" on-tap="_add"></paper-icon-button>
        <paper-icon-button id="delete" title="Delete" icon="icons:delete" on-tap="_delete"></paper-icon-button>
      </div>

      <!-- Swipe right action -->
      <div id="right" swipe-right-action swipe-size="160" swipe-rubber-band="20">
        <paper-icon-button id="outdent" title="Outdent" icon="icons:arrow-back" on-tap="_outdent"></paper-icon-button>
        <paper-icon-button id="indent" title="Indent" icon="icons:arrow-forward" on-tap="_indent"></paper-icon-button>
        <paper-icon-button id="up" title="Move Up" icon="icons:arrow-upward" on-tap="_up"></paper-icon-button>
        <paper-icon-button id="down" title="Move Down" icon="icons:arrow-downward" on-tap="_down"></paper-icon-button>
      </div>
    </swipe-action>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="enter"
    on-keys-pressed="_onEnter"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="backspace"
    on-keys-pressed="_onBackspace"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="up"
    on-keys-pressed="_onUp"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="down"
    on-keys-pressed="_onDown"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="tab"
    on-keys-pressed="_onTab"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="shift+tab"
    on-keys-pressed="_onShiftTab"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="alt+up"
    on-keys-pressed="_onAltUp"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="alt+down"
    on-keys-pressed="_onAltDown"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="shift+up"
    on-keys-pressed="_onShiftUp"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="shift+down"
    on-keys-pressed="_onShiftDown"></iron-a11y-keys>
  </template>

  <script>
    Polymer({

      is: 'lrnsys-outline-item',
      listeners: {
        'change': '_onChange',
      },
      properties: {
        id: {
          type: String,
          value: null,
        },
        value: {
          type: String,
          value: null,
          reflectToAttribute: true,
        },
        parent: {
          type: String,
          value: null,
        },
        indent: {
          type: Number,
          value: 0,
        },
        target: {
          type: Object,
          value: null,
        },
      },
      attached: function(){
        this.fire('attached-item', {item: this});
      },
      ready: function(){
        this.target = this.$.input;
      },
      focus: function(){
        this.$.input.focus();
        return this;
      },
      value: function(){
        this.title = this.$.input.value;
        return this.title;
      },
      _delete: function() {
        this.fire('delete-item', {item: this});
        this.$.swipe.reset();
      },
      _indent: function() {
        this.fire('indent-item', {item: this, increase: true});
        this.$.swipe.reset();
      },
      _outdent: function() {
        this.fire('indent-item', {item: this, increase: false});
        this.$.swipe.reset();
      },
      _add: function() {
        let i = this.$.input.querySelector('input').selectionStart, j = this.$.input.value;
        this.fire('add-item', {item: this, value: j.slice(0, i), new: j.slice(i, j.length)});
        this.$.swipe.reset();
      },
      _up: function() {
        this.fire('move-item', {item: this, moveUp: true, byGroup: true});
        this.$.swipe.reset();
      },
      _down: function() {
        this.fire('move-item', {item: this, moveUp: false, byGroup: true});
        this.$.swipe.reset();
      },
      setSelection: function(start,end){
        let s = start !== undefined ? start : 0, n = end !== undefined ? end : s;
        try {
          this.$.input.querySelector('input').setSelectionRange(s,n);
        } catch (e){
          console.log(e);
        }
        this.focus();
      },
      _onChange: function(){
        this.fire('change-item', {item: this, value: this.$.input.value});
      },
      _onEnter: function(){
        let i = this.$.input.querySelector('input').selectionStart, j = this.$.input.value;
        this.fire('add-item', {item: this, value: j.slice(0, i), new: j.slice(i, j.length)});
      },
      _onBackspace: function(e){
        if (window.getSelection().toString() == this.$.input.value){
          event.detail.keyboardEvent.preventDefault();
          this.fire('delete-item', {item: this});
        } else if (this.$.input.querySelector('input').selectionStart == 0) {
          this.fire('indent-item', {item: this, increase: false});
        }
      },
      _onUp: function(){
        if (this.$.input.querySelector('input').selectionStart == 0) {
          this.fire('focus-item', {item: this, moveUp: true});
        }
      },
      _onDown: function(){
        if (this.$.input.querySelector('input').selectionStart == this.$.input.value.length) {
          this.fire('focus-item', {item: this, moveUp: false});
        }
      },
      _onShiftTab: function(){
        this.fire('indent-item', {item: this, increase: false});
      },
      _onTab: function(e){
        //e.preventDefault();
        if (this.$.input.querySelector('input').selectionStart == 0) {
          e.preventDefault();
          this.fire('indent-item', {item: this, increase: true});
        }
      },
      _onAltUp: function(){
        this.fire('move-item', {item: this, moveUp: true, byGroup: false});
      },
      _onAltDown: function(){
        this.fire('move-item', {item: this, moveUp: false, byGroup: false});
      },
      _onShiftUp: function(){
        this.fire('move-item', {item: this, moveUp: true, byGroup: true});
      },
      _onShiftDown: function(){
        this.fire('move-item', {item: this, moveUp: false, byGroup: true});
      },
    });
  </script>
</dom-module>
