<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="lrnsys-outline-item.html">

<!--
`lrnsys-outline`
A LRN element

@demo demo/index.html

@microcopy - the mental model for this element
 -
 -
 -

-->

<dom-module id="lrnsys-outline">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <h1>[[title]]</h1>
    <div id="itemslist">
      <template id="domRepeat" is="dom-repeat" items$="[[items]]" as="item">
        <lrnsys-outline-item id$="{{item.id}}" title$="{{item.title}}" indent$="{{item.indent}}" parent$="{{item.parent}}"></lrnsys-outline-item>
      </template>
    </div>
  </template>

  <script>
    Polymer({

      is: 'lrnsys-outline',
      
      listeners: {
        'add-item': '_addItem',
        'delete-item': '_deleteItem',
        'indent-item': '_indentItem',
        'focus-item': '_focusItem',
        'add-item': '_addItem',
        'move-item': '_moveItem',
      },

      properties: {
        title: {
          type: String,
          value: 'Content Outline',
        },
        data: {
          type: Array,
          value: [{title: '', order: 0, parent: null}],
        },
        items: {
          type: Array,
          value: null,
          notify: true,
        },
      },
      ready: function(){
        this.setData(this.data);
      },
      /**
       * adds a new item
       */
      new: function(item){
        this.__tempid = this.__tempid+1;
        let items = this.items, i = this.items.findIndex(j => j.id === item.id);
        items.splice(i+1, 0, {id: 'outline-item-'+this.__tempid, title: '', indent: item.indent});
        this.items = [];
        this.items = items;
        this.$$('#itemslist').querySelectorAll('lrnsys-outline-item')[i+1].focus();
      },
      /**
       * removes an item
       */
      remove: function(item){
        let i = this.items.findIndex(j => j.id === item.id), items;
        if (confirm('Do you really want to delete '+this.items[i].title+'?')) {
          for (k in this.items){
            if(this.items[k].parent == this.items[i].id) {
              this._decreaseIndent(this.items[k]);
            }
          }
          this.items.splice(i, 1);
          items = this.items;
          this.items = [];
          this.items = items;
          this.$$('#itemslist').querySelectorAll('lrnsys-outline-item')[i-1].focus();
        }
      },
      /**
       * gets a nested array of items to convert & updates the dom-repeat
       */
      setData: function(data){
        this.items = [];
        if(data !== undefined && data.length > 0){
          for (i in data) {
            this.__tempid = this.__tempid === undefined ? 0 : this.__tempid + 1;
            data[i].indent = this._getIndent(data,i);
            data[i].id === data[i].id === undefined ? this.__tempid : data[i].id;
          }
        }
        this.items = data;
      },
      /**
       * converts a nested array of items and returns a flat list with indents
       */
      _getIndent: function(data,i){
        if (data[i].parent !== undefined) {
          let k = data.findIndex(j => j.id === data[i].parent);
          if (data[k] !== undefined && data[k].indent !== undefined){
            return data[k].indent+1;
          }
        }
        return 0;
      },
      /**
       * gets a flat array of items to convert & updates it to a nested array
       */
      getData: function(){
        for (i in this.items){
          this.items[i].order = this._getOrder(this.items[i]);
        }
        console.log(this.items);
        return this.items;
      },
      /**
       * returns an array or siblings
       */
      _getOrder: function(item){
        let ctr = 0,order = 0;
        for (i in this.items){
          if(this.items[i].parent == item.parent && this.items[i].id == item.id) {
            order = ctr;
          } else if (this.items[i].parent == item.parent) {
            ctr++;
          }
        }
        return order;
      },
      /**
       * listener to add an item
       */
      _addItem: function(e){
        this.new(e.detail.item);
      },
      /**
       * listener to delete an item
       */
      _deleteItem: function(e){
        this.remove(e.detail.item);
      },
      /**
       * listener to move focus up or down
       */
      _focusItem: function(e){
        if(e.detail.moveUp){
          e.detail.item.previousElementSibling.focus();
        } else {
          e.detail.item.nextElementSibling.focus();
        }
      },
      /**
       * det an item by item id
       */
      _getItemById: function(id,offset){
        let i = this.items.findIndex(j => j.id === id);
        offset = offset === undefined ? 0 : offset;
        if (this.items[i+offset] !== undefined){
          return this.items[i+offset];
        } else {
          return undefined;
        }
      },
      /**
       * listener to increase or decrease indent
       */
      _indentItem: function(e){
        let items;
        if (e.detail.increase){
          this._increaseIndent(this._getItemById(e.detail.item.id));
        } else {
          this._decreaseIndent(this._getItemById(e.detail.item.id));
        }
        items = this.items;
        this.items = [];
        this.items = items;
      },
      /**
       * increase indent
       */
      _increaseIndent: function(item){
        let prev = this._getItemById(item.id,-1), next = this._getItemById(item.id,1), indent = item.indent;
        if(item !== undefined && prev !== undefined && item.indent - prev.indent <= 0) {
          item.indent = indent + 1;
          item.parent = this._getItemById(item.id,-1).id;
          while(next !== undefined && indent < next.indent){
            next.indent = next.indent + 1;
            next = this._getItemById(next.id,1);
          }
          items = this.items;
          this.items = [];
          this.items = items;
        }
      },
      /**
       * decrease indent
       */
      _decreaseIndent: function(item){
        let next = this._getItemById(item.id,1), indent = item.indent;
        if(indent > 0) {
          item.indent = item.indent - 1;
          item.parent = this._getItemById(item.parent).parent;
          while(next !== undefined && indent < next.indent){
            next.indent = next.indent - 1;
            next = this._getItemById(next.id,1);
          }
        }
      },
    });
  </script>
</dom-module>
